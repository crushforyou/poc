### 漏洞信息

Next.js 是一个基于 React 的流行 Web 应用框架，提供服务器端渲染、静态网站生成和集成路由系统等功能。包含众多功能，是深入研究复杂研究的完美游乐场。在信念、好奇心和韧性的推动下，我们出发去探索它鲜为人知的方面，寻找等待被发现的隐藏宝藏。

当使用中间件进行身份验证和授权时，Next.js 14.2.25 和 15.2.3 之前的版本存在授权绕过漏洞。

该漏洞允许攻击者通过操作 `x-middleware-subrequest` 请求头来绕过基于中间件的安全控制，从而可能获得对受保护资源和敏感数据的未授权访问。

补丁：

- 对于 Next.js 15.x，此问题已在 15.2.3 中修复
- 对于 Next.js 14.x，此问题已在 14.2.25 中修复

### 漏洞复现

vulhub已有环境：[vulhub/next.js/CVE-2025-29927/README.zh-cn.md at master · vulhub/vulhub (github.com)](https://github.com/vulhub/vulhub/blob/master/next.js/CVE-2025-29927/README.zh-cn.md)

启动环境：



```x86asm
docker compose up -d
```

[![img](CVE-2025-29927%20Next.js%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87.assets/2855436-20250324115925601-936367598.png)](https://img2024.cnblogs.com/blog/2855436/202503/2855436-20250324115925601-936367598.png)

访问虚拟机3000端口,可以看到环境搭建成功：http://your-ip:3000/login

[![img](CVE-2025-29927%20Next.js%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87.assets/2855436-20250324115930128-1046305236.png)](https://img2024.cnblogs.com/blog/2855436/202503/2855436-20250324115930128-1046305236.png)

访问根路径，显示需要登陆：

[![img](CVE-2025-29927%20Next.js%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87.assets/2855436-20250324115938816-1109577171.png)](https://img2024.cnblogs.com/blog/2855436/202503/2855436-20250324115938816-1109577171.png)

添加请求头，使用权限绕过payload



```makefile
x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware
```

ext.js 在处理用户请求时，会检查 x-middleware-subrequest 以识别内部子请求，防止中间件递归调用。但在受影响版本中，对该头的来源与拼接方式**缺乏严格校验**，导致**外部恶意请求**也能带上此头，从而骗过 Next.js 判断逻辑，完全绕过中间件安全机制。

在老版本（如 12.2 以下）时，攻击者可使用：

```html
x-middleware-subrequest: pages/_middleware
```

在较新版本中（如 13.x、14.x、15.x），需使用更复杂的字符串，例如：

```html
x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware
```

或

```html
x-middleware-subrequest: src/middleware:middleware:middleware
```

来触发绕过行为。



访问成功，权限绕过漏洞复现成功

[![img](CVE-2025-29927%20Next.js%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87.assets/2855436-20250324115936641-1030015712.png)](https://img2024.cnblogs.com/blog/2855436/202503/2855436-20250324115936641-1030015712.png)

## 五、修复与缓解

### 1. 升级到安全版本

**最直接与安全**的方案是升级到官方发布的**带安全补丁**的版本：

- **Next.js 15.x**: 升级到 >= 15.2.3
- **Next.js 14.x**: 升级到 >= 14.2.25
- **Next.js 13.x**: 升级到 >= 13.5.9
- **Next.js 12.x**: 升级到 >= 12.3.5

### 2. 临时措施：拦截 x-middleware-subrequest 在 Edge/Proxy 层

如果在短期内无法进行升级，可在反向代理或负载均衡层（如 Nginx、Cloudflare、AWS ALB）**直接丢弃或重写来自外部的 x-middleware-subrequest**，确保只有真正的内部请求头能通过。示例 Nginx 配置：

```html
proxy_set_header x-middleware-subrequest "";
```

或使用 ACL 拦截任何外部请求带有该头的情况。但要注意，这种做法需要在**Next.js 中间件以外**的地方实现，否则也可能被绕过。