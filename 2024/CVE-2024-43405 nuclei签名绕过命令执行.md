## **2. CVE-2024-43405 - Nuclei 签名验证绕过**

Nuclei 支持 HTTP、TCP、DNS、TLS 和Code等多种协议。其中，Code协议允许用户在主机上执行代码。安全研究人员通常使用该协议来测试自己的系统安全状况。

不过，这种Code协议也能让威胁行为者通过恶意 YAML 模板执行未经授权的远程代码。Nuclei 使用包括四个步骤的签名验证方法来验证所有 YAML 模板。

- **提取 YAML 中的签名**- 使用 Regex 在 YAML 模板上查找# digest :行
- **移除签名**- 从模板内容中移除签名。
- **计算哈希值**- 对不含签名的剩余内容进行哈希处理
- **验证签名**- 将生成的哈希值与提取的签名进行比较，以验证真实性

一旦模板的签名通过验证，就会使用 Go 的 YAML 库解析模板并执行代码。然而，我们发现签名验证方法存在缺陷。

总结 Wiz 安全研究人员的发现、

- 签名验证过程只检查第一行# digest :行，但会从散列内容中删除随后的 regex 匹配行，从而允许未验证的# digest :行存在
- YAML 将x0A 视为 \n，将x0D 视为 \r。另一方面，Go regex 解析器将\n视为换行符，而\r实际上是空闲的。



*YAML 换行字符（来源：* *YAML 文档）*

利用这种 regex 匹配内容的不匹配，威胁行为者可以伪造出如下恶意 YAML 模板：

```yaml
id: benign-template
info:
  name: Valid Template Example
  author: Wiz Research
  severity: Low
# digest: &amp;lt;valid-signature&amp;gt;
# digest: &amp;lt;injected-signature&amp;gt;\rcode:\r\r  engine:\r    - sh\r  source: |\r    echo "This is injected and executed!" &amp;gt; /tmp/payload.txt
```

该模板允许绕过签名验证，因为"# digest :"内容只被移除第一行。后面的行会被忽略。同样，Go 的 regex 解析器会将\r 视为同一行的一部分，YAML 会断行。考虑到这些情况，上述模板将变成如下样子：

这将导致内嵌在 YAML 模板中的恶意代码被执行，并且许多组织都会在生产环境中的机器内执行nuclei。

恶意编码的模板还可能导致在生产环境中执行恶意软件或勒索软件，造成灾难性后果。ProjectDiscovery 已收到有关这一发现的通知，并发布了针对该漏洞的修补版本。

## **3.修复**

为防止此漏洞被利用，建议 "nuclei "用户

- 将 Nuclei 升级到 3.3.2 或更高版本
- 在隔离环境中运行 Nuclei